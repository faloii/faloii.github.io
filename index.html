<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>쿠팡 Apple 할인 트래커</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo',
                   'Malgun Gothic', sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.5;
    }

    header {
      background: #fff;
      border-bottom: 1px solid #d2d2d7;
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1d1d1f;
    }

    h1 span { color: #0071e3; }

    .subtitle {
      font-size: 14px;
      color: #86868b;
      margin-top: 4px;
    }

    .controls {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #d2d2d7;
      border-radius: 20px;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .filter-btn:hover { border-color: #0071e3; color: #0071e3; }
    .filter-btn.active { background: #0071e3; color: #fff; border-color: #0071e3; }

    .sort-select {
      margin-left: auto;
      padding: 8px 12px;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    .stats {
      max-width: 1200px;
      margin: 0 auto 16px;
      padding: 0 20px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 24px;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .stat-label { font-size: 13px; color: #86868b; }
    .stat-value { font-size: 28px; font-weight: 700; margin-top: 4px; }
    .stat-value.highlight { color: #bf4800; }

    .grid {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 40px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .card-body {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .card-category {
      font-size: 12px;
      color: #0071e3;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-name {
      font-size: 16px;
      font-weight: 600;
      margin-top: 6px;
      color: #1d1d1f;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-name a {
      text-decoration: none;
      color: inherit;
    }
    .card-name a:hover { color: #0071e3; }

    .card-prices {
      margin-top: auto;
      padding-top: 16px;
    }

    .price-original {
      font-size: 14px;
      color: #86868b;
      text-decoration: line-through;
    }

    .price-row {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-top: 4px;
    }

    .price-current {
      font-size: 22px;
      font-weight: 700;
      color: #1d1d1f;
    }

    .discount-badge {
      display: inline-block;
      background: #bf4800;
      color: #fff;
      font-size: 13px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 6px;
    }

    .discount-badge.none {
      background: #86868b;
    }

    .savings {
      font-size: 13px;
      color: #bf4800;
      margin-top: 4px;
      font-weight: 500;
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #86868b;
      font-size: 16px;
    }

    .updated {
      text-align: center;
      padding: 20px;
      font-size: 13px;
      color: #86868b;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #86868b;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #d2d2d7;
      border-top-color: #0071e3;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 640px) {
      h1 { font-size: 22px; }
      .grid { grid-template-columns: 1fr; }
      .stat-card { min-width: 140px; }
      .controls { gap: 8px; }
      .filter-btn { padding: 6px 12px; font-size: 13px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <h1><span>Apple</span> 할인 트래커</h1>
      <p class="subtitle">쿠팡 애플 브랜드샵 가격 모니터링</p>
    </div>
  </header>

  <div class="controls" id="controls"></div>
  <div class="stats" id="stats"></div>
  <div class="grid" id="grid">
    <div class="loading">
      <div class="loading-spinner"></div>
      데이터 로딩 중...
    </div>
  </div>
  <div class="updated" id="updated"></div>

  <script>
    let allProducts = [];
    let currentFilter = '전체';
    let currentSort = 'discount';

    async function init() {
      try {
        const res = await fetch('data/products.json');
        const data = await res.json();
        allProducts = data.products || [];
        renderUpdated(data.lastUpdated);
        renderControls();
        renderStats();
        renderGrid();
      } catch (e) {
        document.getElementById('grid').innerHTML =
          '<div class="no-data">데이터를 불러올 수 없습니다.<br>GitHub Actions가 실행된 후 데이터가 표시됩니다.</div>';
      }
    }

    function renderUpdated(iso) {
      if (!iso) return;
      const d = new Date(iso);
      const str = d.toLocaleString('ko-KR', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit', hour12: false,
        timeZone: 'Asia/Seoul',
      });
      document.getElementById('updated').textContent = `마지막 업데이트: ${str}`;
    }

    function getCategories() {
      const cats = new Set(allProducts.map(p => p.category));
      return ['전체', ...Array.from(cats).sort()];
    }

    function renderControls() {
      const cats = getCategories();
      const el = document.getElementById('controls');

      const buttons = cats.map(c =>
        `<button class="filter-btn${c === currentFilter ? ' active' : ''}"
                onclick="setFilter('${c}')">${c}</button>`
      ).join('');

      el.innerHTML = buttons +
        `<select class="sort-select" onchange="setSort(this.value)">
          <option value="discount"${currentSort === 'discount' ? ' selected' : ''}>할인율 높은 순</option>
          <option value="savings"${currentSort === 'savings' ? ' selected' : ''}>절약 금액 큰 순</option>
          <option value="price-low"${currentSort === 'price-low' ? ' selected' : ''}>낮은 가격 순</option>
          <option value="price-high"${currentSort === 'price-high' ? ' selected' : ''}>높은 가격 순</option>
          <option value="name"${currentSort === 'name' ? ' selected' : ''}>이름 순</option>
        </select>`;
    }

    function renderStats() {
      const filtered = getFiltered();
      const deals = filtered.filter(p => p.discountPercent > 0);
      const maxDiscount = deals.length ? Math.max(...deals.map(p => p.discountPercent)) : 0;
      const totalSavings = deals.reduce((s, p) => s + (p.savings || 0), 0);

      document.getElementById('stats').innerHTML = `
        <div class="stat-card">
          <div class="stat-label">전체 상품</div>
          <div class="stat-value">${filtered.length}개</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">할인 중</div>
          <div class="stat-value highlight">${deals.length}개</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">최대 할인율</div>
          <div class="stat-value highlight">${maxDiscount}%</div>
        </div>`;
    }

    function getFiltered() {
      let list = allProducts;
      if (currentFilter !== '전체') {
        list = list.filter(p => p.category === currentFilter);
      }
      return sortProducts(list);
    }

    function sortProducts(list) {
      const copy = [...list];
      switch (currentSort) {
        case 'discount':
          return copy.sort((a, b) => (b.discountPercent || 0) - (a.discountPercent || 0));
        case 'savings':
          return copy.sort((a, b) => (b.savings || 0) - (a.savings || 0));
        case 'price-low':
          return copy.sort((a, b) => a.price - b.price);
        case 'price-high':
          return copy.sort((a, b) => b.price - a.price);
        case 'name':
          return copy.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
        default:
          return copy;
      }
    }

    function fmt(n) {
      return n.toLocaleString('ko-KR');
    }

    function renderGrid() {
      const products = getFiltered();
      if (!products.length) {
        document.getElementById('grid').innerHTML =
          '<div class="no-data">해당 카테고리에 상품이 없습니다.</div>';
        return;
      }

      document.getElementById('grid').innerHTML = products.map(p => {
        const hasDiscount = p.discountPercent > 0;
        const badgeClass = hasDiscount ? '' : ' none';
        const badgeText = hasDiscount ? `-${p.discountPercent}%` : '할인 없음';

        return `
          <div class="card">
            <div class="card-body">
              <div class="card-category">${p.category || '기타'}</div>
              <div class="card-name">
                ${p.url
                  ? `<a href="${p.url}" target="_blank" rel="noopener">${p.name}</a>`
                  : p.name}
              </div>
              <div class="card-prices">
                ${hasDiscount
                  ? `<div class="price-original">정가 ${fmt(p.originalPrice)}원</div>`
                  : ''}
                <div class="price-row">
                  <span class="price-current">${fmt(p.price)}원</span>
                  <span class="discount-badge${badgeClass}">${badgeText}</span>
                </div>
                ${hasDiscount
                  ? `<div class="savings">${fmt(p.savings)}원 절약</div>`
                  : ''}
              </div>
            </div>
          </div>`;
      }).join('');
    }

    function setFilter(cat) {
      currentFilter = cat;
      renderControls();
      renderStats();
      renderGrid();
    }

    function setSort(val) {
      currentSort = val;
      renderGrid();
    }

    init();
  </script>
</body>
</html>
