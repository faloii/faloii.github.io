<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>쿠팡 Apple 할인 트래커</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo',
                   'Malgun Gothic', sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.5;
    }

    header {
      background: #fff;
      border-bottom: 1px solid #d2d2d7;
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .header-left {}

    h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1d1d1f;
    }

    h1 span { color: #0071e3; }

    .subtitle {
      font-size: 14px;
      color: #86868b;
      margin-top: 4px;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .crawl-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background: #0071e3;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .crawl-btn:hover { background: #0077ed; }
    .crawl-btn:active { transform: scale(0.97); }
    .crawl-btn:disabled {
      background: #86868b;
      cursor: not-allowed;
      transform: none;
    }

    .crawl-btn .icon { font-size: 16px; }

    .settings-btn {
      width: 36px;
      height: 36px;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .settings-btn:hover { border-color: #0071e3; }
    .settings-btn.configured { border-color: #34c759; background: #f0fdf4; }

    .crawl-status {
      font-size: 12px;
      color: #86868b;
      text-align: right;
      min-width: 160px;
    }

    .crawl-status.running { color: #0071e3; }
    .crawl-status.success { color: #34c759; }
    .crawl-status.error { color: #ff3b30; }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal h2 {
      font-size: 20px;
      margin-bottom: 8px;
    }

    .modal p {
      font-size: 13px;
      color: #86868b;
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .modal label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .modal input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      font-size: 14px;
      font-family: monospace;
      margin-bottom: 16px;
    }

    .modal input:focus {
      outline: none;
      border-color: #0071e3;
      box-shadow: 0 0 0 3px rgba(0,113,227,0.15);
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .modal-actions button {
      padding: 8px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-cancel {
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      color: #1d1d1f;
    }

    .btn-save {
      background: #0071e3;
      border: none;
      color: #fff;
    }

    .btn-save:hover { background: #0077ed; }

    .controls {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #d2d2d7;
      border-radius: 20px;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .filter-btn:hover { border-color: #0071e3; color: #0071e3; }
    .filter-btn.active { background: #0071e3; color: #fff; border-color: #0071e3; }

    .sort-select {
      margin-left: auto;
      padding: 8px 12px;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    .stats {
      max-width: 1200px;
      margin: 0 auto 16px;
      padding: 0 20px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 24px;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .stat-label { font-size: 13px; color: #86868b; }
    .stat-value { font-size: 28px; font-weight: 700; margin-top: 4px; }
    .stat-value.highlight { color: #bf4800; }

    .grid {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 40px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .card-body {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .card-category {
      font-size: 12px;
      color: #0071e3;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-name {
      font-size: 16px;
      font-weight: 600;
      margin-top: 6px;
      color: #1d1d1f;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-name a {
      text-decoration: none;
      color: inherit;
    }
    .card-name a:hover { color: #0071e3; }

    .card-prices {
      margin-top: auto;
      padding-top: 16px;
    }

    .price-original {
      font-size: 14px;
      color: #86868b;
      text-decoration: line-through;
    }

    .price-row {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-top: 4px;
    }

    .price-current {
      font-size: 22px;
      font-weight: 700;
      color: #1d1d1f;
    }

    .discount-badge {
      display: inline-block;
      background: #bf4800;
      color: #fff;
      font-size: 13px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 6px;
    }

    .discount-badge.none { background: #86868b; }

    .savings {
      font-size: 13px;
      color: #bf4800;
      margin-top: 4px;
      font-weight: 500;
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #86868b;
      font-size: 16px;
      line-height: 1.8;
    }

    .updated {
      text-align: center;
      padding: 20px;
      font-size: 13px;
      color: #86868b;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #86868b;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #d2d2d7;
      border-top-color: #0071e3;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 640px) {
      h1 { font-size: 22px; }
      .header-inner { flex-direction: column; align-items: flex-start; }
      .grid { grid-template-columns: 1fr; }
      .stat-card { min-width: 140px; }
      .controls { gap: 8px; }
      .filter-btn { padding: 6px 12px; font-size: 13px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-left">
        <h1><span>Apple</span> 할인 트래커</h1>
        <p class="subtitle">쿠팡 애플 브랜드샵 가격 모니터링</p>
      </div>
      <div class="header-actions">
        <div class="crawl-status" id="crawlStatus"></div>
        <button class="crawl-btn" id="crawlBtn" onclick="triggerCrawl()">
          <span class="icon">&#x21bb;</span> 크롤링 시작
        </button>
        <button class="settings-btn" id="settingsBtn" onclick="openSettings()" title="GitHub 토큰 설정">&#x2699;</button>
      </div>
    </div>
  </header>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <h2>GitHub 토큰 설정</h2>
      <p>
        크롤링 버튼을 사용하려면 GitHub Personal Access Token이 필요합니다.<br>
        <a href="https://github.com/settings/tokens?type=beta" target="_blank">github.com/settings/tokens</a>에서 발급하세요.<br>
        필요 권한: <strong>Actions (Read and write)</strong>
      </p>
      <label for="tokenInput">Personal Access Token</label>
      <input type="password" id="tokenInput" placeholder="github_pat_..." autocomplete="off">
      <p style="font-size:12px;color:#86868b;">토큰은 브라우저 localStorage에만 저장되며 외부로 전송되지 않습니다.</p>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeSettings()">취소</button>
        <button class="btn-save" onclick="saveToken()">저장</button>
      </div>
    </div>
  </div>

  <div class="controls" id="controls"></div>
  <div class="stats" id="stats"></div>
  <div class="grid" id="grid">
    <div class="loading">
      <div class="loading-spinner"></div>
      데이터 로딩 중...
    </div>
  </div>
  <div class="updated" id="updated"></div>

  <script>
    const REPO = 'faloii/faloii.github.io';
    const WORKFLOW_FILE = 'update-prices.yml';
    const TOKEN_KEY = 'gh_actions_token';

    let allProducts = [];
    let currentFilter = '전체';
    let currentSort = 'discount';

    // ----- Init -----
    async function init() {
      updateSettingsIcon();
      try {
        const res = await fetch('data/products.json');
        const data = await res.json();
        allProducts = data.products || [];
        renderUpdated(data.lastUpdated);
        if (allProducts.length) {
          renderControls();
          renderStats();
          renderGrid();
        } else {
          document.getElementById('controls').innerHTML = '';
          document.getElementById('stats').innerHTML = '';
          document.getElementById('grid').innerHTML =
            '<div class="no-data">아직 수집된 데이터가 없습니다.<br>오른쪽 상단의 <strong>크롤링 시작</strong> 버튼을 눌러주세요.</div>';
        }
      } catch (e) {
        document.getElementById('grid').innerHTML =
          '<div class="no-data">데이터를 불러올 수 없습니다.<br><strong>크롤링 시작</strong> 버튼으로 데이터를 수집해주세요.</div>';
      }
    }

    // ----- Crawl trigger -----
    async function triggerCrawl() {
      const token = localStorage.getItem(TOKEN_KEY);
      if (!token) {
        openSettings();
        return;
      }

      const btn = document.getElementById('crawlBtn');
      const status = document.getElementById('crawlStatus');

      btn.disabled = true;
      btn.innerHTML = '<span class="icon">&#x21bb;</span> 실행 중...';
      status.className = 'crawl-status running';
      status.textContent = 'Workflow 트리거 중...';

      try {
        // Trigger workflow
        const triggerRes = await fetch(
          `https://api.github.com/repos/${REPO}/actions/workflows/${WORKFLOW_FILE}/dispatches`,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/vnd.github+json',
            },
            body: JSON.stringify({ ref: 'master' }),
          }
        );

        if (triggerRes.status === 204) {
          status.textContent = 'Workflow 시작됨. 완료까지 약 2~3분...';
          pollWorkflowStatus(token);
        } else if (triggerRes.status === 401 || triggerRes.status === 403) {
          status.className = 'crawl-status error';
          status.textContent = '토큰 권한 오류. 설정을 확인하세요.';
          btn.disabled = false;
          btn.innerHTML = '<span class="icon">&#x21bb;</span> 크롤링 시작';
        } else {
          const err = await triggerRes.json().catch(() => ({}));
          status.className = 'crawl-status error';
          status.textContent = `오류: ${err.message || triggerRes.status}`;
          btn.disabled = false;
          btn.innerHTML = '<span class="icon">&#x21bb;</span> 크롤링 시작';
        }
      } catch (e) {
        status.className = 'crawl-status error';
        status.textContent = '네트워크 오류';
        btn.disabled = false;
        btn.innerHTML = '<span class="icon">&#x21bb;</span> 크롤링 시작';
      }
    }

    async function pollWorkflowStatus(token) {
      const btn = document.getElementById('crawlBtn');
      const status = document.getElementById('crawlStatus');
      let attempts = 0;
      const maxAttempts = 40; // ~4 minutes

      const poll = async () => {
        attempts++;
        if (attempts > maxAttempts) {
          status.className = 'crawl-status error';
          status.textContent = '시간 초과. Actions 탭에서 확인하세요.';
          btn.disabled = false;
          btn.innerHTML = '<span class="icon">&#x21bb;</span> 크롤링 시작';
          return;
        }

        try {
          const res = await fetch(
            `https://api.github.com/repos/${REPO}/actions/workflows/${WORKFLOW_FILE}/runs?per_page=1`,
            {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/vnd.github+json',
              },
            }
          );
          const data = await res.json();
          const run = data.workflow_runs?.[0];

          if (!run) {
            setTimeout(poll, 6000);
            return;
          }

          if (run.status === 'completed') {
            if (run.conclusion === 'success') {
              status.className = 'crawl-status success';
              status.textContent = '크롤링 완료! 페이지 새로고침 중...';
              setTimeout(() => location.reload(), 3000);
            } else {
              status.className = 'crawl-status error';
              status.textContent = `실패: ${run.conclusion}`;
              btn.disabled = false;
              btn.innerHTML = '<span class="icon">&#x21bb;</span> 크롤링 시작';
            }
            return;
          }

          const elapsed = Math.round((Date.now() - new Date(run.created_at)) / 1000);
          status.textContent = `실행 중... (${elapsed}초 경과)`;
          setTimeout(poll, 6000);
        } catch {
          setTimeout(poll, 6000);
        }
      };

      setTimeout(poll, 5000);
    }

    // ----- Settings -----
    function openSettings() {
      const modal = document.getElementById('settingsModal');
      const input = document.getElementById('tokenInput');
      input.value = localStorage.getItem(TOKEN_KEY) || '';
      modal.classList.add('open');
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('open');
    }

    function saveToken() {
      const token = document.getElementById('tokenInput').value.trim();
      if (token) {
        localStorage.setItem(TOKEN_KEY, token);
      } else {
        localStorage.removeItem(TOKEN_KEY);
      }
      updateSettingsIcon();
      closeSettings();
    }

    function updateSettingsIcon() {
      const btn = document.getElementById('settingsBtn');
      const token = localStorage.getItem(TOKEN_KEY);
      btn.classList.toggle('configured', !!token);
    }

    // Close modal on overlay click
    document.getElementById('settingsModal').addEventListener('click', function(e) {
      if (e.target === this) closeSettings();
    });

    // ----- Display -----
    function renderUpdated(iso) {
      if (!iso) {
        document.getElementById('updated').textContent = '';
        return;
      }
      const d = new Date(iso);
      const str = d.toLocaleString('ko-KR', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit', hour12: false,
        timeZone: 'Asia/Seoul',
      });
      document.getElementById('updated').textContent = `마지막 업데이트: ${str}`;
    }

    function getCategories() {
      const cats = new Set(allProducts.map(p => p.category));
      return ['전체', ...Array.from(cats).sort()];
    }

    function renderControls() {
      const cats = getCategories();
      const el = document.getElementById('controls');

      const buttons = cats.map(c =>
        `<button class="filter-btn${c === currentFilter ? ' active' : ''}"
                onclick="setFilter('${c}')">${c}</button>`
      ).join('');

      el.innerHTML = buttons +
        `<select class="sort-select" onchange="setSort(this.value)">
          <option value="discount"${currentSort === 'discount' ? ' selected' : ''}>할인율 높은 순</option>
          <option value="savings"${currentSort === 'savings' ? ' selected' : ''}>절약 금액 큰 순</option>
          <option value="price-low"${currentSort === 'price-low' ? ' selected' : ''}>낮은 가격 순</option>
          <option value="price-high"${currentSort === 'price-high' ? ' selected' : ''}>높은 가격 순</option>
          <option value="name"${currentSort === 'name' ? ' selected' : ''}>이름 순</option>
        </select>`;
    }

    function renderStats() {
      const filtered = getFiltered();
      const deals = filtered.filter(p => p.discountPercent > 0);
      const maxDiscount = deals.length ? Math.max(...deals.map(p => p.discountPercent)) : 0;

      document.getElementById('stats').innerHTML = `
        <div class="stat-card">
          <div class="stat-label">전체 상품</div>
          <div class="stat-value">${filtered.length}개</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">할인 중</div>
          <div class="stat-value highlight">${deals.length}개</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">최대 할인율</div>
          <div class="stat-value highlight">${maxDiscount}%</div>
        </div>`;
    }

    function getFiltered() {
      let list = allProducts;
      if (currentFilter !== '전체') {
        list = list.filter(p => p.category === currentFilter);
      }
      return sortProducts(list);
    }

    function sortProducts(list) {
      const copy = [...list];
      switch (currentSort) {
        case 'discount':
          return copy.sort((a, b) => (b.discountPercent || 0) - (a.discountPercent || 0));
        case 'savings':
          return copy.sort((a, b) => (b.savings || 0) - (a.savings || 0));
        case 'price-low':
          return copy.sort((a, b) => a.price - b.price);
        case 'price-high':
          return copy.sort((a, b) => b.price - a.price);
        case 'name':
          return copy.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
        default:
          return copy;
      }
    }

    function fmt(n) {
      return n.toLocaleString('ko-KR');
    }

    function renderGrid() {
      const products = getFiltered();
      if (!products.length) {
        document.getElementById('grid').innerHTML =
          '<div class="no-data">해당 카테고리에 상품이 없습니다.</div>';
        return;
      }

      document.getElementById('grid').innerHTML = products.map(p => {
        const hasDiscount = p.discountPercent > 0;
        const badgeClass = hasDiscount ? '' : ' none';
        const badgeText = hasDiscount ? `-${p.discountPercent}%` : '할인 없음';

        return `
          <div class="card">
            <div class="card-body">
              <div class="card-category">${p.category || '기타'}</div>
              <div class="card-name">
                ${p.url
                  ? `<a href="${p.url}" target="_blank" rel="noopener">${p.name}</a>`
                  : p.name}
              </div>
              <div class="card-prices">
                ${hasDiscount
                  ? `<div class="price-original">정가 ${fmt(p.originalPrice)}원</div>`
                  : ''}
                <div class="price-row">
                  <span class="price-current">${fmt(p.price)}원</span>
                  <span class="discount-badge${badgeClass}">${badgeText}</span>
                </div>
                ${hasDiscount
                  ? `<div class="savings">${fmt(p.savings)}원 절약</div>`
                  : ''}
              </div>
            </div>
          </div>`;
      }).join('');
    }

    function setFilter(cat) {
      currentFilter = cat;
      renderControls();
      renderStats();
      renderGrid();
    }

    function setSort(val) {
      currentSort = val;
      renderGrid();
    }

    init();
  </script>
</body>
</html>
